<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umre & Hac Maliyet Hesaplayıcı v2.5 (Otomatik Paket Adı)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
        .container { max-width: 900px; background-color: #fff; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 4px_8px rgba(0,0,0,0.05); }
        h1, h2, h3, h4, h5 { color: #003d73; font-weight: 600; }
        h2 { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; font-size: 1.5rem; }
        .form-label { font-weight: 500; }
        #teklifCiktisi { border: 1px solid #dee2e6; padding: 2rem; margin-top: 2rem; border-radius: 0.5rem; background-color: #ffffff;}
        .btn-loading .spinner-border { width: 1.2rem; height: 1.2rem; }
        .preserve-whitespace { white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container my-5">
    <div class="text-center mb-5">
        <h1>Umre & Hac Maliyet Hesaplayıcı</h1>
        <p class="text-muted">Fiyat teklifinizi kolayca oluşturun, PDF veya Excel olarak indirin.</p>
    </div>

    <section>
        <h2><i class="bi bi-info-circle-fill"></i> Genel Bilgiler</h2>
        <div class="row">
            <div class="col-md-6 mb-3"><label for="firmaAdi" class="form-label">Firma Adı</label><input type="text" class="form-control" id="firmaAdi" placeholder="Firma Adı"></div>
            <div class="col-md-6 mb-3"><label for="grupLideri" class="form-label">Grup Lideri Adı</label><input type="text" class="form-control" id="grupLideri" placeholder="Grup Lideri"></div>
            <div class="col-md-6 mb-3"><label for="grupKisiSayisi" class="form-label">Grup Kişi Sayısı</label><input type="number" class="form-control" id="grupKisiSayisi" placeholder="40"></div>
            <div class="col-md-3 mb-3"><label for="talepTarihi" class="form-label">Teklif Başlangıç Tarihi</label><input type="date" class="form-control" id="talepTarihi"></div>
            <div class="col-md-3 mb-3"><label for="talepBitisTarihi" class="form-label">Teklif Bitiş Tarihi</label><input type="date" class="form-control" id="talepBitisTarihi"></div>
        </div>
    </section>
    
    <section class="mt-4">
        <h2><i class="bi bi-building"></i> Medine Otel Bilgileri</h2>
        <div class="row">
            <div class="col-md-12 mb-3"><label for="medineOtelAdi" class="form-label">Otel Adı</label><input type="text" class="form-control" id="medineOtelAdi" placeholder="Medine Otel Adı"></div>
            <div class="col-md-4 mb-3"><label for="medineGiris" class="form-label">Giriş Tarihi</label><input type="date" class="form-control" id="medineGiris" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="medineCikis" class="form-label">Çıkış Tarihi</label><input type="date" class="form-control" id="medineCikis" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="medineGece" class="form-label">Gece Sayısı</label><input type="text" class="form-control" id="medineGece" readonly></div>
        </div>
        <div id="medineInputs"></div>
    </section>
    <section class="mt-4">
        <h2><i class="bi bi-moon-stars-fill"></i> Mekke Otel Bilgileri</h2>
        <div class="row">
            <div class="col-md-12 mb-3"><label for="mekkeOtelAdi" class="form-label">Otel Adı</label><input type="text" class="form-control" id="mekkeOtelAdi" placeholder="Mekke Otel Adı"></div>
            <div class="col-md-4 mb-3"><label for="mekkeGiris" class="form-label">Giriş Tarihi</label><input type="date" class="form-control" id="mekkeGiris" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="mekkeCikis" class="form-label">Çıkış Tarihi</label><input type="date" class="form-control" id="mekkeCikis" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="mekkeGece" class="form-label">Gece Sayısı</label><input type="text" class="form-control" id="mekkeGece" readonly></div>
        </div>
        <div id="mekkeInputs"></div>
    </section>
    <section class="mt-4">
        <h2><i class="bi bi-passport-fill"></i> Vize Maliyeti</h2>
        <div class="row"><div class="col-md-6" id="vizeInputs"></div></div>
    </section>
    <section class="mt-4">
        <h2><i class="bi bi-bus-front-fill"></i> Ulaşım Maliyetleri</h2>
        <p class="text-muted">Toplam maliyet, belirtilen grup sayısına bölünecektir.</p>
        <div id="ulasimInputs"></div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-card-checklist"></i> Notlar</h2>
        <div class="mb-3">
            <label for="dahilHizmetlerNotu" class="form-label">Fiyata Dahil Olan Hizmetler</label>
            <textarea class="form-control" id="dahilHizmetlerNotu" rows="4" placeholder="- Sabah Kahvaltısı ve Akşam Yemeği&#10;- Vize Ücreti&#10;- Tüm Ulaşımlar"></textarea>
        </div>
    </section>
    
    <button id="calculateBtn" class="btn btn-primary w-100 btn-lg mt-4" onclick="createProposal()">
        <span class="btn-text"><i class="bi bi-calculator-fill"></i> Teklif Oluştur</span>
    </button>
    
    <div id="teklifCiktisi" class="mt-4" style="display:none;"></div>
    <div id="exportButtons" class="text-center mt-3" style="display: none;">
        <button id="exportPdfBtn" class="btn btn-danger me-2"><i class="bi bi-file-earmark-pdf-fill"></i> PDF Olarak İndir</button>
        <button id="exportXlsxBtn" class="btn btn-success"><i class="bi bi-file-earmark-excel-fill"></i> Excel Olarak İndir</button>
    </div>
</div>

<script>
    // --- YARDIMCI FONKSİYONLAR (Değişiklik Yok) ---
    function createRoomPriceInput(id,label,p){return`<div class="col-md-4 mb-3"><label class="form-label">${label} Günlük Oda Fiyatı</label><div class="input-group"><input type="number" class="form-control" id="${id}" placeholder="${p}"><select class="form-select" id="${id}Currency" style="max-width:100px"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div>`}
    function createMealInput(id,p){return`<div class="col-md-12 mb-3"><label class="form-label">Kişi Başı Günlük Yemek Ücreti</label><div class="input-group"><input type="number" class="form-control" id="${id}" placeholder="${p}"><select class="form-select" id="${id}Currency" style="max-width:100px"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div>`}
    function createVisaInput(id,l,p){return`<div class="col-md-12 mb-3"><label class="form-label">${l}</label><div class="input-group"><input type="number" class="form-control" id="${id}" placeholder="${p}"><select class="form-select" id="${id}Currency" style="max-width:100px"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div>`}
    function createTransportInput(id, label, capacity, placeholderCost) {
        return `
        <div class="p-3 border rounded mb-3">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="transportType" id="radio_${id}" value="${id}" ${id === 'bus' ? 'checked' : ''}>
                <label class="form-check-label h5" for="radio_${id}">${label}</label>
            </div>
            <div class="row mt-2 align-items-end">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Araç Sayısı</label>
                    <input type="number" class="form-control" id="${id}Count" placeholder="1" value="1">
                </div>
                <div class="col-md-5 mb-3">
                    <label class="form-label">Araç Başı Maliyet</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="${id}Cost" placeholder="${placeholderCost}">
                        <select class="form-select" id="${id}CostCurrency" style="max-width:100px">
                            <option value="USD">USD</option>
                            <option value="SAR" selected>SAR</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <p class="text-muted mb-1 small">Kapasite: ~${capacity} Kişi</p>
                </div>
            </div>
        </div>`;
    }

    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('medineInputs').innerHTML=`<div class="row">${createRoomPriceInput('medineDbl','DBL','600')}${createRoomPriceInput('medineTrpl','TRPL','750')}${createRoomPriceInput('medineQuad','QUAD','800')}</div><div class="row">${createMealInput('medineYemek','50')}</div>`;
        document.getElementById('mekkeInputs').innerHTML=`<div class="row">${createRoomPriceInput('mekkeDbl','DBL','800')}${createRoomPriceInput('mekkeTrpl','TRPL','950')}${createRoomPriceInput('mekkeQuad','QUAD','1000')}</div><div class="row">${createMealInput('mekkeYemek','60')}</div>`;
        document.getElementById('vizeInputs').innerHTML=createVisaInput('vize','Vize Maliyeti (Kişi Başı)','550');
        let t = createTransportInput('bus', 'Otobüs', '50', '15000');
        t += createTransportInput('hiace', 'Hi-ace', '13', '7000');
        t += createTransportInput('gmc', 'GMC', '7', '9000');
        document.getElementById('ulasimInputs').innerHTML=t;
        document.getElementById('talepTarihi').valueAsDate=new Date();
    });
    
    function calculateNights(){['medine','mekke'].forEach(c=>{const g=document.getElementById(`${c}Giris`).value;const k=document.getElementById(`${c}Cikis`).value;const n=document.getElementById(`${c}Gece`);if(g&&k){const d1=new Date(g);const d2=new Date(k);if(d2>d1){const t=Math.abs(d2-d1);const f=Math.ceil(t/(1e3*60*60*24));n.value=f>0?`${f} Gece`:'';n.dataset.nights=f}else{n.value='';n.dataset.nights=0}}})}
    
    // --- KUR ÇEVRİM FONKSİYONLARI ---
    async function fetchRates() {
        try {
            const response = await fetch('https://api.frankfurter.app/latest?from=SAR&to=USD,EUR');
            if (!response.ok) throw new Error('API yanıt vermedi.');
            const data = await response.json();
            const usdPerSar = data.rates.USD;
            const eurPerSar = data.rates.EUR;
            return {
                USD_PER_SAR: usdPerSar, SAR_PER_USD: 1 / usdPerSar,
                EUR_PER_SAR: eurPerSar, SAR_PER_EUR: 1 / eurPerSar
            };
        } catch (e) {
            console.error("Kur alınamadı:", e);
            alert("UYARI: Anlık kurlar alınamadı. Varsayılan kurlar kullanılacak.");
            return {
                USD_PER_SAR: 0.27, EUR_PER_SAR: 0.25,
                SAR_PER_USD: 3.75, SAR_PER_EUR: 4.05
            };
        }
    }
    
    function getSarValue(id, rates) {
        const amount = parseFloat(document.getElementById(id).value) || 0;
        const currency = document.getElementById(id + 'Currency').value;
        if (currency === 'USD') return amount * rates.SAR_PER_USD;
        if (currency === 'EUR') return amount * rates.SAR_PER_EUR;
        return amount;
    }

    // --- ANA HESAPLAMA VE RAPOR OLUŞTURMA FONKSİYONU ---
    async function createProposal() {
        const calculateBtn = document.getElementById('calculateBtn');
        const btnText = calculateBtn.querySelector('.btn-text');
        calculateBtn.disabled = true;
        btnText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Hesaplama Yapılıyor...';
        
        const rates = await fetchRates(); 
        const groupSize = parseInt(document.getElementById('grupKisiSayisi').value) || 1;
        const medineNights = parseInt(document.getElementById('medineGece').dataset.nights) || 0;
        const mekkeNights = parseInt(document.getElementById('mekkeGece').dataset.nights) || 0;

        // YENİ: Otomatik Paket Adı oluşturuluyor
        const totalNights = medineNights + mekkeNights;
        const totalDays = totalNights + 1;
        const otomatikPaketAdi = totalNights > 0 ? `${totalNights} Gece ${totalDays} Gün Umre Programı` : 'Belirtilmedi';

        const vizePerPersonSar = getSarValue('vize', rates);
        const transportType = document.querySelector('input[name="transportType"]:checked').value;
        const vehicleCount = parseInt(document.getElementById(transportType + 'Count').value) || 1;
        const costPerVehicleSar = getSarValue(transportType + 'Cost', rates);
        const transportTotalCostSar = vehicleCount * costPerVehicleSar;
        const transportPerPersonSar = groupSize > 0 ? transportTotalCostSar / groupSize : 0;
        const medineYemekDailySar = getSarValue('medineYemek', rates);
        const mekkeYemekDailySar = getSarValue('mekkeYemek', rates);
        const totalYemekPerPersonSar = (medineYemekDailySar * medineNights) + (mekkeYemekDailySar * mekkeNights);
        const dailyRoomPricesSar = {
            medine: {dbl: getSarValue('medineDbl', rates), trpl: getSarValue('medineTrpl', rates), quad: getSarValue('medineQuad', rates)},
            mekke: {dbl: getSarValue('mekkeDbl', rates), trpl: getSarValue('mekkeTrpl', rates), quad: getSarValue('mekkeQuad', rates)}
        };
        const totalsSar = {};
        const roomTypes = { dbl: 2, trpl: 3, quad: 4 };
        for (const type in roomTypes) {
            const personsInRoom = roomTypes[type];
            const medineRoomCostPerPerson = medineNights > 0 ? (dailyRoomPricesSar.medine[type] * medineNights) / personsInRoom : 0;
            const mekkeRoomCostPerPerson = mekkeNights > 0 ? (dailyRoomPricesSar.mekke[type] * mekkeNights) / personsInRoom : 0;
            const totalRoomCostPerPerson = medineRoomCostPerPerson + mekkeRoomCostPerPerson;
            totalsSar[type] = totalRoomCostPerPerson + totalYemekPerPersonSar + vizePerPersonSar + transportPerPersonSar;
        }
        
        const formatters = {
            SAR: new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR', maximumFractionDigits: 0, numberingSystem: 'latn' }),
            USD: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }),
            EUR: new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })
        };
        
        // YENİ: Başlangıç ve bitiş tarihleri formatlanıyor
        const talepTarihiFormatted = document.getElementById('talepTarihi').value ? new Date(document.getElementById('talepTarihi').value).toLocaleDateString('tr-TR') : 'N/A';
        const talepBitisTarihiFormatted = document.getElementById('talepBitisTarihi').value ? new Date(document.getElementById('talepBitisTarihi').value).toLocaleDateString('tr-TR') : 'N/A';

        const proposalData = {
            paketAdi: otomatikPaketAdi, // Otomatik isim kullanılıyor
            firmaAdi: document.getElementById('firmaAdi').value || 'N/A',
            grupLideri: document.getElementById('grupLideri').value || 'N/A',
            grupKisiSayisi: document.getElementById('grupKisiSayisi').value || 'N/A',
            talepTarihi: talepTarihiFormatted,
            talepBitisTarihi: talepBitisTarihiFormatted,
            medineOtel: document.getElementById('medineOtelAdi').value || 'Belirtilmedi',
            mekkeOtel: document.getElementById('mekkeOtelAdi').value || 'Belirtilmedi',
            medineGece: document.getElementById('medineGece').value || 'N/A',
            mekkeGece: document.getElementById('mekkeGece').value || 'N/A',
            transportLabel: document.querySelector(`label[for="radio_${transportType}"]`).innerText,
            dahilHizmetler: document.getElementById('dahilHizmetlerNotu').value
        };
        
        // YENİ: Rapor HTML'i güncellendi
        const teklifHTML = `
            <h3 class="text-center mb-4">FİYAT TEKLİFİ</h3>
            <div class="row mb-4">
                <div class="col-md-6"><p><strong>Firma Adı:</strong> ${proposalData.firmaAdi}</p><p><strong>Grup Lideri:</strong> ${proposalData.grupLideri}</p></div>
                <div class="col-md-6 text-md-end"><p><strong>Teklif Geçerlilik Tarihi:</strong> ${proposalData.talepTarihi} - ${proposalData.talepBitisTarihi}</p><p><strong>Grup Kişi Sayısı:</strong> ${proposalData.grupKisiSayisi}</p></div>
            </div>
            <h4>Paket Detayları</h4>
            <ul class="list-group list-group-flush mb-4">
                <li class="list-group-item"><strong>Paket Adı:</strong> ${proposalData.paketAdi}</li>
                <li class="list-group-item"><strong>Medine:</strong> ${proposalData.medineOtel} (${proposalData.medineGece})</li>
                <li class="list-group-item"><strong>Mekke:</strong> ${proposalData.mekkeOtel} (${proposalData.mekkeGece})</li>
                <li class="list-group-item"><strong>Ulaşım:</strong> ${proposalData.transportLabel} (${vehicleCount} adet)</li>
            </ul>
            <h4 class="mt-4">Kişi Başı Her Şey Dahil Fiyatlar</h4>
            <table class="table table-bordered table-striped text-center">
                <thead class="table-primary"><tr><th>Oda Tipi</th><th>SAR (Riyal)</th><th>USD (Dolar)</th><th>EUR (Euro)</th></tr></thead>
                <tbody>
                    <tr><td><strong>DBL Odada Kişi Başı</strong></td><td>${formatters.SAR.format(totalsSar.dbl)}</td><td>${formatters.USD.format(totalsSar.dbl * rates.USD_PER_SAR)}</td><td>${formatters.EUR.format(totalsSar.dbl * rates.EUR_PER_SAR)}</td></tr>
                    <tr><td><strong>TRPL Odada Kişi Başı</strong></td><td>${formatters.SAR.format(totalsSar.trpl)}</td><td>${formatters.USD.format(totalsSar.trpl * rates.USD_PER_SAR)}</td><td>${formatters.EUR.format(totalsSar.trpl * rates.EUR_PER_SAR)}</td></tr>
                    <tr><td><strong>QUAD Odada Kişi Başı</strong></td><td>${formatters.SAR.format(totalsSar.quad)}</td><td>${formatters.USD.format(totalsSar.quad * rates.USD_PER_SAR)}</td><td>${formatters.EUR.format(totalsSar.quad * rates.EUR_PER_SAR)}</td></tr>
                </tbody>
            </table>
            
            ${proposalData.dahilHizmetler ? `
            <h5 class="mt-4">Fiyata Dahil Olan Hizmetler</h5>
            <div class="text-muted small preserve-whitespace">${proposalData.dahilHizmetler}</div>
            ` : ''}

            <div class="text-muted small mt-4"><p><strong>Not:</strong> Döviz kurları ${new Date().toLocaleString('tr-TR')} itibarıyla anlık olarak alınmıştır.</p></div>`;
            
        const outputDiv = document.getElementById('teklifCiktisi');
        outputDiv.innerHTML = teklifHTML;
        outputDiv.style.display = 'block';
        document.getElementById('exportButtons').style.display = 'block';
        outputDiv.scrollIntoView({ behavior: 'smooth' });

        document.getElementById('exportPdfBtn').onclick = () => exportToPdf(proposalData.firmaAdi);
        document.getElementById('exportXlsxBtn').onclick = () => exportToXlsx(proposalData, totalsSar, rates, vehicleCount);

        calculateBtn.disabled = false;
        btnText.innerHTML = '<i class="bi bi-calculator-fill"></i> Tekrar Teklif Oluştur';
    }

    // PDF İndirme Fonksiyonu
    function exportToPdf(firmaAdi) {
        const reportElement = document.getElementById('teklifCiktisi');
        const fileName = `Teklif_${firmaAdi.replace(/ /g, '_') || 'Genel'}.pdf`;
        html2canvas(reportElement, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(fileName);
        });
    }

    // Excel İndirme Fonksiyonu
    function exportToXlsx(data, totals, rates, vehicleCount) {
        const ws_data = [
            ["FİYAT TEKLİFİ"],
            [],
            ["Firma Adı:", data.firmaAdi],
            ["Grup Lideri:", data.grupLideri],
            ["Teklif Geçerlilik Tarihi:", `${data.talepTarihi} - ${data.talepBitisTarihi}`],
            ["Grup Kişi Sayısı:", data.grupKisiSayisi],
            ["Paket Adı:", data.paketAdi],
            ["Medine:", `${data.medineOtel} (${data.medineGece})`],
            ["Mekke:", `${data.mekkeOtel} (${data.mekkeGece})`],
            ["Ulaşım:", `${data.transportLabel} (${vehicleCount} adet)`],
            [],
            ["KİŞİ BAŞI FİYATLAR"],
            ["Oda Tipi", "SAR", "USD", "EUR"],
            ["DBL Odada Kişi Başı", totals.dbl, totals.dbl * rates.USD_PER_SAR, totals.dbl * rates.EUR_PER_SAR],
            ["TRPL Odada Kişi Başı", totals.trpl, totals.trpl * rates.USD_PER_SAR, totals.trpl * rates.EUR_PER_SAR],
            ["QUAD Odada Kişi Başı", totals.quad, totals.quad * rates.USD_PER_SAR, totals.quad * rates.EUR_PER_SAR],
            []
        ];
        
        if(data.dahilHizmetler){
            ws_data.push(["Fiyata Dahil Olan Hizmetler:"]);
            ws_data.push([data.dahilHizmetler]);
            ws_data.push([]);
        }

        ws_data.push([`Not: Kurlar ${new Date().toLocaleString('tr-TR')} itibarıyla alınmıştır.`]);

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
        
        ['B14','C14','D14','B15','C15','D15','B16','C16','D16'].forEach(cell => {
            if(ws[cell]) {
                ws[cell].t = 'n';
                ws[cell].z = '#,##0.00';
            }
        });

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Fiyat Teklifi");
        const fileName = `Teklif_${data.firmaAdi.replace(/ /g, '_') || 'Genel'}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }
</script>

</body>
</html>
