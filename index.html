<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umre & Hac Maliyet Hesaplayıcı (Hata Düzeltildi)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #e9ecef;
            color: #495057;
        }
        .container {
            max-width: 900px;
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        h1, h2, h3, h4 {
            color: #003d73;
            font-weight: 600;
        }
        h2 {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        #teklifCiktisi {
            border: 1px solid #dee2e6;
            padding: 2rem;
            margin-top: 2rem;
            border-radius: 0.5rem;
        }
        .btn-loading .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 0.5rem;
        }
        #countdownDisplay {
            font-size: 1.1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>

<div class="container my-5">
    <div class="text-center mb-5">
        <h1>Umre & Hac Maliyet Hesaplayıcı</h1>
        <p class="text-muted">Döviz kurları anlık olarak otomatik çekilmektedir.</p>
    </div>

    <section>
        <h2><i class="bi bi-info-circle-fill"></i> Genel Bilgiler</h2>
        <div class="row">
            <div class="col-md-6 mb-3"><label for="firmaAdi" class="form-label">Firma Adı</label><input type="text" class="form-control" id="firmaAdi" placeholder="Firma Adı"></div>
            <div class="col-md-6 mb-3"><label for="grupLideri" class="form-label">Grup Lideri Adı</label><input type="text" class="form-control" id="grupLideri" placeholder="Grup Lideri"></div>
            <div class="col-md-6 mb-3"><label for="grupKisiSayisi" class="form-label">Grup Kişi Sayısı</label><input type="number" class="form-control" id="grupKisiSayisi" placeholder="40"></div>
            <div class="col-md-6 mb-3"><label for="talepTarihi" class="form-label">Talep Tarihi</label><input type="date" class="form-control" id="talepTarihi"></div>
        </div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-box-seam-fill"></i> Paket Bilgileri</h2>
        <div class="row align-items-center">
            <div class="col-md-12 mb-3"><label for="paketAdi" class="form-label">Paket Adı</label><input type="text" class="form-control" id="paketAdi" placeholder="Örn: 15 Gecelik Ramazan Umresi"></div>
            <div class="col-md-4 mb-3"><label for="paketBaslangic" class="form-label">Program Başlangıç Tarihi</label><input type="date" class="form-control" id="paketBaslangic" onchange="updatePackageDates()"></div>
            <div class="col-md-4 mb-3"><label for="paketBitis" class="form-label">Program Bitiş Tarihi</label><input type="date" class="form-control" id="paketBitis" onchange="updatePackageDates()"></div>
            <div class="col-md-4 mb-3"><label for="paketGeceSayisi" class="form-label">Toplam Gece Sayısı</label><input type="text" class="form-control" id="paketGeceSayisi" readonly></div>
            <div class="col-12"><div id="countdownDisplay" class="alert alert-info text-center" role="alert" style="display: none;"></div></div>
        </div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-building"></i> Medine Otel Bilgileri ve Maliyetleri</h2>
        <div class="row">
            <div class="col-md-12 mb-3"><label for="medineOtelAdi" class="form-label">Otel Adı</label><input type="text" class="form-control" id="medineOtelAdi" placeholder="Medine Otel Adı"></div>
            <div class="col-md-4 mb-3"><label for="medineGiris" class="form-label">Giriş Tarihi</label><input type="date" class="form-control" id="medineGiris" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="medineCikis" class="form-label">Çıkış Tarihi</label><input type="date" class="form-control" id="medineCikis" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="medineGece" class="form-label">Gece Sayısı</label><input type="text" class="form-control" id="medineGece" readonly></div>
        </div>
        <div id="medineInputs"></div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-moon-stars-fill"></i> Mekke Otel Bilgileri ve Maliyetleri</h2>
        <div class="row">
            <div class="col-md-12 mb-3"><label for="mekkeOtelAdi" class="form-label">Otel Adı</label><input type="text" class="form-control" id="mekkeOtelAdi" placeholder="Mekke Otel Adı"></div>
            <div class="col-md-4 mb-3"><label for="mekkeGiris" class="form-label">Giriş Tarihi</label><input type="date" class="form-control" id="mekkeGiris" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="mekkeCikis" class="form-label">Çıkış Tarihi</label><input type="date" class="form-control" id="mekkeCikis" onchange="calculateNights()"></div>
            <div class="col-md-4 mb-3"><label for="mekkeGece" class="form-label">Gece Sayısı</label><input type="text" class="form-control" id="mekkeGece" readonly></div>
        </div>
        <div id="mekkeInputs"></div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-passport-fill"></i> Vize Maliyeti</h2>
        <div class="row"><div class="col-md-6" id="vizeInputs"></div></div>
    </section>

    <section class="mt-4">
        <h2><i class="bi bi-bus-front-fill"></i> Ulaşım Maliyetleri</h2>
        <p class="text-muted">Lütfen teklife dahil edilecek ulaşım türünü seçin.</p>
        <div id="ulasimInputs"></div>
    </section>
    
    <button id="calculateBtn" class="btn btn-primary w-100 btn-lg mt-4" onclick="createProposal()">
        <span class="btn-text"><i class="bi bi-calculator-fill"></i> Teklif Oluştur</span>
    </button>

    <div id="teklifCiktisi" style="display:none;"></div>

</div>

<script>
    // Dinamik alanları oluşturan fonksiyonlar (Değişiklik yok)
    function createPriceInput(id, label, placeholder) {return `<div class="col-md-4 mb-3"><label class="form-label">${label}</label><div class="input-group"><input type="number" class="form-control" id="${id}" placeholder="${placeholder}"><select class="form-select" id="${id}Currency" style="max-width: 100px;"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div>`;}
    function createMealInput(id, placeholder) {return `<div class="col-md-4 mb-3"><label class="form-label">Yemek Maliyeti (Kişi Başı)</label><div class="input-group"><input type="number" class="form-control" id="${id}" placeholder="${placeholder}"><select class="form-select" id="${id}Currency" style="max-width: 100px;"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div>`;}
    function createTransportInput(id, label, placeholder) {return `<div class="p-3 border rounded mb-3"><div class="form-check"><input class="form-check-input" type="radio" name="transportType" id="radio_${id}" value="${id}" ${id === 'bus' ? 'checked' : ''}><label class="form-check-label h5" for="radio_${id}">${label}</label></div><div class="row mt-2"><div class="col-md-4"><input type="number" class="form-control" placeholder="Araç Sayısı"></div><div class="col-md-4"><input type="number" class="form-control" placeholder="Yolcu Sayısı"></div><div class="col-md-4"><div class="input-group"><input type="number" class="form-control" id="${id}Cost" placeholder="${placeholder}"><select class="form-select" id="${id}CostCurrency" style="max-width: 100px;"><option value="USD">USD</option><option value="SAR" selected>SAR</option><option value="EUR">EUR</option></select></div></div></div></div>`;}
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('medineInputs').innerHTML = `<div class="row">${createPriceInput('medineDbl', 'DBL Oda', '600')}${createPriceInput('medineTrpl', 'TRPL Oda', '550')}${createPriceInput('medineQuad', 'QUAD Oda', '500')}${createMealInput('medineYemek', '150')}</div>`;
        document.getElementById('mekkeInputs').innerHTML = `<div class="row">${createPriceInput('mekkeDbl', 'DBL Oda', '800')}${createPriceInput('mekkeTrpl', 'TRPL Oda', '750')}${createPriceInput('mekkeQuad', 'QUAD Oda', '700')}${createMealInput('mekkeYemek', '200')}</div>`;
        document.getElementById('vizeInputs').innerHTML = createPriceInput('vize', 'Vize Maliyeti (Kişi Başı)', '550');
        let transportHTML = createTransportInput('bus', 'Otobüs', '15000'); transportHTML += createTransportInput('hiace', 'Hi-ace', '7000'); transportHTML += createTransportInput('gmc', 'GMC', '9000');
        document.getElementById('ulasimInputs').innerHTML = transportHTML;
        document.getElementById('talepTarihi').valueAsDate = new Date();
    });

    // Otel gece sayılarını hesapla (Değişiklik yok)
    function calculateNights() {['medine', 'mekke'].forEach(city => {const giris = document.getElementById(`${city}Giris`).value; const cikis = document.getElementById(`${city}Cikis`).value; if (giris && cikis) {const date1 = new Date(giris); const date2 = new Date(cikis); if (date2 > date1) {const diffTime = Math.abs(date2 - date1); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); document.getElementById(`${city}Gece`).value = diffDays > 0 ? `${diffDays} Gece` : '';} else {document.getElementById(`${city}Gece`).value = '';}}});}
    
    // Paket tarihlerini ve geri sayımı güncelleyen fonksiyon (Değişiklik yok)
    function updatePackageDates() {const startDateEl = document.getElementById('paketBaslangic'); const endDateEl = document.getElementById('paketBitis'); const nightCountEl = document.getElementById('paketGeceSayisi'); const countdownEl = document.getElementById('countdownDisplay'); const startDate = startDateEl.value; const endDate = endDateEl.value; if (startDate && endDate) {const date1 = new Date(startDate); const date2 = new Date(endDate); if (date2 > date1) {const diffTime = Math.abs(date2 - date1); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); nightCountEl.value = `${diffDays} Gece`;} else {nightCountEl.value = '';}} if (startDate) {const today = new Date(); today.setHours(0, 0, 0, 0); const arrivalDate = new Date(startDate); arrivalDate.setHours(0, 0, 0, 0); const diffTime = arrivalDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); countdownEl.style.display = 'block'; if (diffDays > 0) {countdownEl.className = 'alert alert-info text-center'; countdownEl.innerHTML = `<i class="bi bi-calendar-check"></i> Grubun gelişine <strong>${diffDays}</strong> gün kaldı.`;} else if (diffDays === 0) {countdownEl.className = 'alert alert-success text-center'; countdownEl.innerHTML = `<i class="bi bi-check-circle-fill"></i> Grup bugün geliyor!`;} else {countdownEl.className = 'alert alert-warning text-center'; countdownEl.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Bu programın başlangıç tarihi geçmiş.`;}} else {countdownEl.style.display = 'none';}}
    
    // *** GÜNCELLENDİ *** Kurları API'den çeken ve HATA KONTROLÜ yapan fonksiyon
    async function fetchRates() {
        try {
            const response = await fetch('https://api.frankfurter.app/latest?to=SAR,USD,EUR');
            if (!response.ok) {
                // Eğer ağ yanıtı başarısızsa (404, 500 vb.), bir hata fırlat
                throw new Error('Ağ yanıtı başarısız oldu.');
            }
            const data = await response.json();

            // API'den gelen verinin geçerli olup olmadığını kontrol et
            if (!data || !data.rates || !data.rates.SAR || !data.rates.USD) {
                throw new Error('API yanıtı eksik veya geçersiz veri içeriyor.');
            }
            
            // Çapraz kurları hesapla
            const eurToSar = data.rates.SAR;
            const eurToUsd = data.rates.USD;
            const rates = {
                usd: eurToSar / eurToUsd, // 1 USD'nin kaç SAR ettiği
                eur: eurToSar,           // 1 EUR'nun kaç SAR ettiği
            };
            return rates;
        } catch (error) {
            // Herhangi bir hata durumunda (ağ hatası, geçersiz veri vb.) bu blok çalışır
            console.error("Otomatik kur bilgisi alınamadı:", error);
            alert("UYARI: Anlık döviz kurları alınamadı. Hesaplama, güvenli ortalama kurlar (1 USD = 3.75 SAR) üzerinden yapılacaktır.");
            // Güvenli, varsayılan kurları döndür
            return { usd: 3.75, eur: 4.05 };
        }
    }

    // Değerleri al ve SAR'a çevir (Değişiklik yok)
    function getSarValue(id, rates) {const amount = parseFloat(document.getElementById(id).value) || 0; const currency = document.getElementById(id + 'Currency').value; if (currency === 'USD') return amount * rates.usd; if (currency === 'EUR') return amount * rates.eur; return amount;}

    // Teklifi oluştur (Değişiklik yok)
    async function createProposal() {
        const calculateBtn = document.getElementById('calculateBtn');
        const btnText = calculateBtn.querySelector('.btn-text');
        calculateBtn.disabled = true;
        btnText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Kurlar Alınıyor...';
        const rates = await fetchRates();
        btnText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Hesaplama Yapılıyor...';
        const groupSize = parseInt(document.getElementById('grupKisiSayisi').value) || 1;
        const costsSar = { vize: getSarValue('vize', rates), medineYemek: getSarValue('medineYemek', rates), mekkeYemek: getSarValue('mekkeYemek', rates), medineOda: {dbl: getSarValue('medineDbl', rates), trpl: getSarValue('medineTrpl', rates), quad: getSarValue('medineQuad', rates)}, mekkeOda: {dbl: getSarValue('mekkeDbl', rates), trpl: getSarValue('mekkeTrpl', rates), quad: getSarValue('mekkeQuad', rates)}};
        const transportType = document.querySelector('input[name="transportType"]:checked').value;
        const transportTotalCostSar = getSarValue(transportType + 'Cost', rates);
        const transportPerPersonSar = transportTotalCostSar / groupSize;
        const totalsSar = {};
        ['dbl', 'trpl', 'quad'].forEach(type => {totalsSar[type] = costsSar.medineOda[type] + costsSar.mekkeOda[type] + costsSar.vize + costsSar.medineYemek + costsSar.mekkeYemek + transportPerPersonSar;});
        const formatters = { SAR: new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR', maximumFractionDigits: 0 }), USD: new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }), EUR: new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 })};
        const proposalData = { paketAdi: document.getElementById('paketAdi').value || 'Belirtilmedi', paketGece: document.getElementById('paketGeceSayisi').value || 'N/A', firmaAdi: document.getElementById('firmaAdi').value || 'N/A', grupLideri: document.getElementById('grupLideri').value || 'N/A', grupKisiSayisi: document.getElementById('grupKisiSayisi').value || 'N/A', talepTarihi: new Date(document.getElementById('talepTarihi').value).toLocaleDateString('tr-TR'), medineOtel: document.getElementById('medineOtelAdi').value || 'Belirtilmedi', mekkeOtel: document.getElementById('mekkeOtelAdi').value || 'Belirtilmedi', medineGece: document.getElementById('medineGece').value || 'N/A', mekkeGece: document.getElementById('mekkeGece').value || 'N/A', transportLabel: document.querySelector(`label[for="radio_${transportType}"]`).innerText};
        const teklifHTML = `<h3 class="text-center mb-4">FİYAT TEKLİFİ</h3><div class="row mb-4"><div class="col-md-6"><p><strong>Firma Adı:</strong> ${proposalData.firmaAdi}</p><p><strong>Grup Lideri:</strong> ${proposalData.grupLideri}</p></div><div class="col-md-6 text-md-end"><p><strong>Talep Tarihi:</strong> ${proposalData.talepTarihi}</p><p><strong>Grup Kişi Sayısı:</strong> ${proposalData.grupKisiSayisi}</p></div></div><h4>Paket Bilgileri</h4><ul class="list-group list-group-flush mb-4"><li class="list-group-item"><strong>Paket Adı:</strong> ${proposalData.paketAdi}</li><li class="list-group-item"><strong>Toplam Süre:</strong> ${proposalData.paketGece}</li><li class="list-group-item"><strong>Medine Oteli:</strong> ${proposalData.medineOtel} (${proposalData.medineGece})</li><li class="list-group-item"><strong>Mekke Oteli:</strong> ${proposalData.mekkeOtel} (${proposalData.mekkeGece})</li><li class="list-group-item"><strong>Ulaşım:</strong> ${proposalData.transportLabel}</li></ul><h4 class="mt-4">Toplam Kişi Başı Her Şey Dahil Ücretler</h4><table class="table table-bordered table-striped"><thead class="table-primary"><tr><th>Oda Tipi</th><th class="text-end">SAR (Riyal)</th><th class="text-end">USD (Dolar)</th><th class="text-end">EUR (Euro)</th></tr></thead><tbody><tr><td><strong>DBL Odada Kişi Başı</strong></td><td class="text-end">${formatters.SAR.format(totalsSar.dbl)}</td><td class="text-end">${formatters.USD.format(totalsSar.dbl / rates.usd)}</td><td class="text-end">${formatters.EUR.format(totalsSar.dbl / rates.eur)}</td></tr><tr><td><strong>TRPL Odada Kişi Başı</strong></td><td class="text-end">${formatters.SAR.format(totalsSar.trpl)}</td><td class="text-end">${formatters.USD.format(totalsSar.trpl / rates.usd)}</td><td class="text-end">${formatters.EUR.format(totalsSar.trpl / rates.eur)}</td></tr><tr><td><strong>QUAD Odada Kişi Başı</strong></td><td class="text-end">${formatters.SAR.format(totalsSar.quad)}</td><td class="text-end">${formatters.USD.format(totalsSar.quad / rates.usd)}</td><td class="text-end">${formatters.EUR.format(totalsSar.quad / rates.eur)}</td></tr></tbody></table><div class="text-muted small mt-3"><p><strong>Not:</strong> Belirtilen fiyatlara konaklama, seçilen ulaşım, vize ve belirtilen yemek hizmetleri dahildir.</p><p>Döviz kurları ${new Date().toLocaleString('tr-TR')} itibarıyla anlık olarak alınmıştır.</p></div>`;
        const outputDiv = document.getElementById('teklifCiktisi');
        outputDiv.innerHTML = teklifHTML;
        outputDiv.style.display = 'block';
        outputDiv.scrollIntoView({ behavior: 'smooth' });
        calculateBtn.disabled = false;
        btnText.innerHTML = '<i class="bi bi-calculator-fill"></i> Teklif Oluştur';
    }
</script>

</body>
</html>
